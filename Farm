local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
   Name = "Duel Warriors: Anti-Stranger Sync v19",
   LoadingTitle = "Đang tối ưu logic né người lạ...",
   ConfigurationSaving = { Enabled = false }
})

local Tab = Window:CreateTab("Auto Duel", 4483362458)
local MiscTab = Window:CreateTab("Misc", 4483345909)

-- Variables
local autoWin = false
local autoLose = false
local autoClearMVP = false
local opponentName = ""
local currentRoomIndex = 1 

-- [HỆ THỐNG ANTI-AFK]
local VirtualUser = game:GetService("VirtualUser")
game:GetService("Players").LocalPlayer.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

local function getPlayerNames()
    local names = {}
    for _, player in pairs(game.Players:GetPlayers()) do
        if player ~= game.Players.LocalPlayer then table.insert(names, player.Name) end
    end
    return names
end

-- [TAB CÀI ĐẶT]
local PlayerDropdown = Tab:CreateDropdown({
   Name = "Chọn Đối Thủ (B)",
   Options = getPlayerNames(),
   CurrentOption = {""},
   Callback = function(Option) opponentName = Option[1] end,
})

Tab:CreateButton({
   Name = "Làm mới Player",
   Callback = function() PlayerDropdown:Set(getPlayerNames()) end,
})

Tab:CreateSection("Chế độ Win/Lose")

-- 1. LOGIC CHO MÁY WIN (Siêu tốc 0.01s)
Tab:CreateToggle({
   Name = "Auto Win (Instant Follow)",
   CurrentValue = false,
   Callback = function(Value)
      autoWin = Value
      if Value then
          autoLose = false
          task.spawn(function()
              while autoWin do
                  local targetPlayer = game.Players:FindFirstChild(opponentName)
                  if targetPlayer and targetPlayer.Character and targetPlayer.Character:FindFirstChild("HumanoidRootPart") then
                      local oppPos = targetPlayer.Character.HumanoidRootPart.Position
                      for i = 1, 6 do
                          local group = workspace.Scene.Function.DuelEnter["1V1Group"..i]
                          if (oppPos - group.TransPos2.Position).Magnitude < 10 then
                              game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame = group.TransPos1.CFrame
                              break
                          elseif (oppPos - group.TransPos1.Position).Magnitude < 10 then
                              game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame = group.TransPos2.CFrame
                              break
                          end
                      end
                  end
                  task.wait(0.01)
              end
          end)
      end
   end,
})

-- 2. LOGIC CHO MÁY LOSE (Né người lạ + Quét 6 phòng)
Tab:CreateToggle({
   Name = "Auto Lose (Stranger Avoidance)",
   CurrentValue = false,
   Callback = function(Value)
      autoLose = Value
      if Value then
          autoWin = false
          task.spawn(function()
              while autoLose do
                  local lp = game.Players.LocalPlayer
                  if not lp.Character or not lp.Character:FindFirstChild("HumanoidRootPart") then task.wait(1) continue end
                  
                  -- Chọn phòng theo thứ tự 1-6
                  local group = workspace.Scene.Function.DuelEnter["1V1Group"..currentRoomIndex]
                  
                  -- KIỂM TRA NGƯỜI LẠ (Stranger Detection)
                  local strangerDetected = false
                  for _, p in pairs(game.Players:GetPlayers()) do
                      -- Nếu player không phải là mình VÀ không phải máy Win
                      if p ~= lp and p.Name ~= opponentName then
                          if p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
                              local pPos = p.Character.HumanoidRootPart.Position
                              -- Quét bán kính 10m quanh cả 2 cổng vào của Group hiện tại
                              local dist1 = (pPos - group.TransPos1.Position).Magnitude
                              local dist2 = (pPos - group.TransPos2.Position).Magnitude
                              
                              if dist1 < 10 or dist2 < 10 then
                                  strangerDetected = true
                                  break
                              end
                          end
                      end
                  end

                  if strangerDetected then
                      -- Nếu thấy người lạ, nhảy sang Index tiếp theo ngay mà không thèm TP tới
                      print("Phát hiện người lạ tại phòng "..currentRoomIndex..", đang bỏ qua...")
                      currentRoomIndex = currentRoomIndex + 1
                      if currentRoomIndex > 6 then currentRoomIndex = 1 end
                      task.wait(0.05)
                      continue
                  end

                  -- NẾU PHÒNG AN TOÀN: NHẢY VÀO
                  lp.Character.HumanoidRootPart.CFrame = group.TransPos2.CFrame
                  
                  local startTime = tick()
                  local entered = false
                  
                  -- Đợi tối đa 0.6s để game khớp trận
                  while tick() - startTime < 2 do
                      task.wait(0.05)
                      if lp.Character and lp.Character:FindFirstChild("HumanoidRootPart") then
                          local floor = workspace.Map.MatchDuel.DuelArena["1V1No"..currentRoomIndex].Floor
                          if (lp.Character.HumanoidRootPart.Position - floor.Position).Magnitude < 80 then
                              entered = true
                              break
                          end
                      end
                  end

                  if entered then
                      -- TRẬN ĐẤU BẮT ĐẦU: Reset 2 hiệp
                      task.wait(0.2)
                      local hum = lp.Character:FindFirstChildOfClass("Humanoid")
                      if hum then hum.Health = 0 end
                      
                      task.wait(1.5)
                      local char = lp.Character or lp.CharacterAdded:Wait()
                      task.wait(1.2)
                      
                      local floor = workspace.Map.MatchDuel.DuelArena["1V1No"..currentRoomIndex].Floor
                      local timeout2 = 0
                      repeat 
                          task.wait(0.1) 
                          timeout2 = timeout2 + 0.1
                      until (lp.Character.HumanoidRootPart.Position - floor.Position).Magnitude < 80 or timeout2 > 10 or not autoLose
                      
                      local hum2 = lp.Character:FindFirstChildOfClass("Humanoid")
                      if hum2 then hum2.Health = 0 end
                      task.wait(3)
                  else
                      -- KHÔNG KHỚP TRẬN SAU 0.6S: Đổi phòng
                      currentRoomIndex = currentRoomIndex + 1
                      if currentRoomIndex > 6 then currentRoomIndex = 1 end
                  end
                  
                  task.wait(0.05)
              end
          end)
      end
   end,
})

-- [TAB MISC]
MiscTab:CreateToggle({
   Name = "Auto Clear MVP (30s)",
   CurrentValue = false,
   Callback = function(Value)
      autoClearMVP = Value
      if Value then
          task.spawn(function()
              while autoClearMVP do
                  pcall(function()
                      local mvpPos = workspace.Scene.SafeIsland.DuelLobby.WinnerTable.MVPPos
                      for _, container in pairs(mvpPos:GetChildren()) do
                          for _, item in pairs(container:GetChildren()) do
                              if not item:IsA("Camera") and not string.find(item.Name:lower(), "cam") then
                                  item:Destroy()
                              end
                          end
                      end
                  end)
                  task.wait(30)
              end
          end)
      end
   end,
})

MiscTab:CreateButton({ 
    Name = "Destroy UI", 
    Callback = function() 
        autoWin = false 
        autoLose = false 
        autoClearMVP = false
        Rayfield:Destroy() 
    end 
})
